<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pantry Pad â€“ SB-Layout</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--shadow:0 8px 22px rgba(0,0,0,.08);--brand:#6a5cff;--brand2:#20c997;--danger:#ff6b6b}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}
button{cursor:pointer}
[hidden]{display:none!important}

/* HOME */
.home{min-height:100vh;display:grid;gap:22px;place-content:center;padding:26px;background:linear-gradient(135deg,#6a5cff,#20c997);color:#fff;text-align:center}
.topbar{display:flex;justify-content:center;margin-bottom:6px}
.choices{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));width:min(900px,96vw);margin:0 auto}
.choice{display:flex;align-items:center;gap:12px;padding:18px;border-radius:16px;border:none;background:#fff;color:#222;box-shadow:var(--shadow);font-size:1.05rem}
.choice .icon{font-size:1.6rem}
.choice.view{border-left:10px solid var(--brand2)}
.choice.shop{border-left:10px solid #ff7ab6}
.choice.dash{border-left:10px solid #66d9e8}
.choice.market{border-left:10px solid #ffd43b}

/* HEADER */
header{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
header h1{margin:0;font-size:1.1rem}
header input,header select{padding:8px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem}
header .ghost{background:#fff;color:#333;border:1px solid var(--line);padding:8px 12px;border-radius:10px}
header .primary{background:var(--brand);color:#fff;border:none;padding:8px 12px;border-radius:10px}

/* LAYOUT */
.wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 60px)}
aside{background:#fff;border-right:1px solid var(--line);padding:12px}
.aside-title{font-weight:700;margin:4px 0 10px}
.cat-list{display:flex;flex-direction:column;gap:8px}
.cat{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fafafa}
.cat.active{background:#eaf2ff;border-color:#bcd4ff;font-weight:700}
main{padding:14px}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.tile{position:relative;background:var(--card);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--line)}
.imgwrap{width:100%;aspect-ratio:1/1;background:#eee;display:grid;place-items:center;overflow:hidden}
.tile img{width:100%;height:100%;object-fit:cover}
.body{padding:12px}
.name{font-weight:800}
.meta{font-size:.92rem;color:#555;margin-top:4px}
.ribbon{position:absolute;top:10px;left:10px;background:#fff3cd;color:#7a4e00;padding:6px 8px;border-radius:10px;font-size:.8rem}
.ribbon.exp{background:#fde2e0;color:#8b1a1a}
.empty{padding:40px;text-align:center;color:#777}

/* STAT */
.page{padding:16px}
.stat{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}

/* DIALOG */
dialog{width:min(560px,96vw);border:none;border-radius:16px;padding:0;box-shadow:var(--shadow)}
dialog header,dialog footer{padding:12px 16px}
dialog header{border-bottom:1px solid var(--line)}
dialog form{padding:16px;display:grid;gap:10px}
dialog input,dialog select,dialog textarea{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem}
dialog footer{border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
.primary{background:var(--brand2);color:#fff;border:none;padding:10px 12px;border-radius:10px}
.ghost2{background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:10px}
.danger{background:var(--danger);color:#fff;border:none;padding:10px 12px;border-radius:10px}
</style>
</head>
<body>

<!-- HOME -->
<section id="home" class="home">
  <div class="topbar"></div>
  <h1>ğŸ‘‹ Willkommen im Pantry Pad</h1>
  <p>Bitte wÃ¤hle:</p>
  <div class="choices">
    <button class="choice view"   onclick="go('inventory')"><span class="icon">ğŸ‘€</span><span><b>Nachschauen</b><br><small>Produkte ansehen</small></span></button>
    <button class="choice shop"   onclick="go('shop')"><span class="icon">ğŸ›’</span><span><b>Einkaufsliste</b><br><small>Fehlendes abhaken</small></span></button>
    <button class="choice dash"   onclick="go('dashboard')"><span class="icon">ğŸ“Š</span><span><b>Dashboard</b><br><small>Ãœberblick & Warnungen</small></span></button>
    <button class="choice market" onclick="go('markets')"><span class="icon">ğŸª</span><span><b>SupermÃ¤rkte</b><br><small>Logo â†’ Kategorie â†’ Produkte</small></span></button>
  </div>
</section>

<!-- INVENTORY (SB: Kategorien links, Produkte rechts) -->
<section id="inventoryPage" hidden>
  <header>
    <button class="ghost" onclick="go('home')">ğŸ </button>
    <h1 style="margin-right:auto">ğŸ“¦ Nachschauen</h1>
    <input id="q" placeholder="Suchen â€¦" oninput="renderInventory()">
    <button class="primary" id="addBtn">+ Produkt</button>
  </header>
  <div class="wrap">
    <aside>
      <div class="aside-title">Kategorien</div>
      <div id="catList" class="cat-list"></div>
    </aside>
    <main>
      <div id="invGrid" class="grid"></div>
      <div id="invEmpty" class="empty" hidden>Keine Produkte. Mit â€+ Produktâ€œ hinzufÃ¼gen.</div>
    </main>
  </div>
</section>

<!-- SHOPPING -->
<section id="shopPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">ğŸ </button>
    <h1 style="margin:0 8px">ğŸ›’ Einkaufsliste</h1>
  </header>

  <div class="stat">
    <b>âŒ Fehlend</b>
    <div id="shopMissing"></div>
  </div>

  <div class="stat">
    <b>ğŸ›’ Warenkorb</b>
    <div id="shopCart"></div>
  </div>
</section> 
  /* ==== Shopping (mit Warenkorb) ==== */
async function renderShop(){
  const all = await getAll();
  const missing = all.filter(it => (it.qty||0) === 0);

  const shopMissing = document.getElementById('shopMissing');
  const shopCart = document.getElementById('shopCart');

  shopMissing.innerHTML = '';
  shopCart.innerHTML = '';

  if(missing.length === 0){
    shopMissing.innerHTML = '<div>Alles da âœ…</div>';
    return;
  }

  missing.forEach(it => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '10px';
    row.style.marginTop = '8px';

    row.innerHTML = `
      <img src="${it.imgUrl||''}" 
           onerror="this.src='https://via.placeholder.com/40'" 
           style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:1px solid #eee">
      <span style="flex:1">${it.name}</span>
    `;

    // Toggle fÃ¼r Warenkorb
    const toggle = document.createElement('input');
    toggle.type = 'checkbox';
    toggle.onchange = () => {
      if(toggle.checked){
        // in Warenkorb verschieben
        const cRow = row.cloneNode(true);
        cRow.querySelector('input')?.remove(); // kein Toggle im Warenkorb
        const btn = document.createElement('button');
        btn.textContent = "âœ… Gekauft";
        btn.className = "ghost2";
        btn.onclick = async () => {
          it.qty = 1; // wieder verfÃ¼gbar
          await put(it);
          renderShop(); // neu rendern
          renderInventory();
        };
        cRow.appendChild(btn);
        shopCart.appendChild(cRow);
        row.remove();
      }
    };

    row.appendChild(toggle);
    shopMissing.appendChild(row);
  });
}

<!-- DASHBOARD -->
<section id="dashPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">ğŸ </button>
    <h1 style="margin:0 8px">ğŸ“Š Dashboard</h1>
  </header>
  <div class="stat"><b>âš ï¸ Bald ablaufend</b><div id="soonList"></div></div>
  <div class="stat"><b>âŒ Abgelaufen</b><div id="expList"></div></div>
  <div class="stat"><b>ğŸ“¦ Gesamt</b><div id="totalStat"></div></div>
</section>

<!-- MARKETS (Stufe 1 â†’ Logos; Stufe 2 â†’ Kategorien; Stufe 3 â†’ Produkte) -->
<section id="marketPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">ğŸ </button>
    <h1 style="margin:0 8px">ğŸª SupermÃ¤rkte</h1>
    <button class="ghost" id="marketBack" hidden>â¬…ï¸ ZurÃ¼ck</button>
  </header>
  <div id="marketStageGrid" class="grid"></div>
  <div id="marketEmpty" class="empty" hidden>Keine Produkte in dieser Auswahl.</div>
</section>

<!-- PRODUCT DIALOG -->
<dialog id="dlg">
  <header><strong id="dlgTitle">Produkt</strong></header>
  <form method="dialog" id="form">
    <input type="hidden" name="id">
    <input name="name" placeholder="Name (z. B. Mehl 405)" required>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <input name="qty" type="number" placeholder="Menge" value="1">
      <input name="unit" placeholder="Einheit (Stk, kg, L â€¦)">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <select name="cat">
        <option value="">Kategorie wÃ¤hlenâ€¦</option>
        <option>Backwaren</option><option>GetrÃ¤nke</option><option>SÃ¼ÃŸwaren</option>
        <option>Konserven</option><option>GewÃ¼rze</option><option>TiefkÃ¼hl</option>
        <option>Milchprodukte</option><option>Nudeln/Reis</option><option>Sonstiges</option>
      </select>
      <select name="market">
        <option value="">â€” Markt â€”</option>
        <option>Lidl</option><option>Aldi</option><option>Rewe</option><option>Action</option><option>TÃ¼rkischer Markt</option>
      </select>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <select name="place">
        <option>Vorratsschrank</option><option>KÃ¼hlschrank</option><option>Gefrierfach</option>
      </select>
      <input name="mhd" type="date" placeholder="MHD">
    </div>
    <input name="imgUrl" placeholder="Bild-URL (optional)">
    <textarea name="notes" rows="2" placeholder="Notizen (optional)"></textarea>
  </form>
  <footer>
    <button id="delBtn" class="danger" hidden>ğŸ—‘ï¸ LÃ¶schen</button>
    <button class="ghost2" onclick="dlg.close()">Abbrechen</button>
    <button id="saveBtn" class="primary">Speichern</button>
  </footer>
</dialog>

<script>
/* ====== DB Setup ====== */
const DB='pantry-sb-v1', STORE='items'; let db;
const openDB=()=>new Promise((res,rej)=>{const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>r.result.createObjectStore(STORE,{keyPath:'id'}); r.onsuccess=()=>{db=r.result;res();}; r.onerror=()=>rej(r.error);});
const st=(m='readonly')=>db.transaction(STORE,m).objectStore(STORE);
const getAll=()=>new Promise((res,rej)=>{const q=st().getAll(); q.onsuccess=()=>res(q.result||[]); q.onerror=()=>rej(q.error);});
const put=(it)=>new Promise((res,rej)=>{const q=st('readwrite').put(it); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error);});
const delItem=(id)=>new Promise((res,rej)=>{const q=st('readwrite').delete(id); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error);});

/* ====== State/Refs ====== */
const home=document.getElementById('home');
const inventoryPage=document.getElementById('inventoryPage');
const invGrid=document.getElementById('invGrid'); const invEmpty=document.getElementById('invEmpty'); const qEl=document.getElementById('q');
const catList=document.getElementById('catList'); let ACTIVE_CAT='Alle';
const shopPage=document.getElementById('shopPage'), shopList=document.getElementById('shopList');
const dashPage=document.getElementById('dashPage'), soonList=document.getElementById('soonList'), expList=document.getElementById('expList'), totalStat=document.getElementById('totalStat');
const marketPage=document.getElementById('marketPage'), marketStageGrid=document.getElementById('marketStageGrid'), marketEmpty=document.getElementById('marketEmpty'), marketBack=document.getElementById('marketBack');
const dlg=document.getElementById('dlg'), form=document.getElementById('form'), dlgTitle=document.getElementById('dlgTitle'), saveBtn=document.getElementById('saveBtn'), delBtn=document.getElementById('delBtn');

let MARKET_STAGE='logos', ACTIVE_MARKET='', ACTIVE_MARKET_CAT='';

/* ====== Helpers ====== */
const daysUntil=ds=>{ if(!ds) return null; const n=new Date(); n.setHours(0,0,0,0); const d=new Date(ds+'T00:00:00'); return Math.floor((d-n)/86400000); };
const seedImage=(emoji,bg)=>`data:image/svg+xml;charset=utf-8,${encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%' height='100%' rx='40' ry='40' fill='"+bg+"'/><text x='50%' y='55%' text-anchor='middle' font-size='400'>"+emoji+"</text></svg>")}`;

/* ====== Seed (Demo) ====== */
async function seedIfEmpty(){
  const all=await getAll(); if(all.length) return;
  const plus=d=>{const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10);};
  const items=[
    {name:'Mehl 405 1kg',qty:3,unit:'kg',cat:'Backwaren',place:'Vorratsschrank',mhd:plus(180),imgUrl:seedImage('ğŸŒ¾','#eef'),market:'Lidl'},
    {name:'SonnenblumenÃ¶l 1L',qty:2,unit:'Fl',cat:'Sonstiges',place:'Vorratsschrank',mhd:plus(90),imgUrl:seedImage('ğŸŸ¡','#fff3cd'),market:'Aldi'},
    {name:'Vollmilch 3,5%',qty:1,unit:'Pack',cat:'Milchprodukte',place:'KÃ¼hlschrank',mhd:plus(3),imgUrl:seedImage('ğŸ¥›','#e8f2ff'),market:'Rewe'},
    {name:'Spaghetti 500g',qty:0,unit:'Pack',cat:'Nudeln/Reis',place:'Vorratsschrank',mhd:plus(365),imgUrl:seedImage('ğŸ','#ffe8d6'),market:'Lidl'},
    {name:'Schokolade 100g',qty:6,unit:'Tafeln',cat:'SÃ¼ÃŸwaren',place:'Vorratsschrank',mhd:plus(240),imgUrl:seedImage('ğŸ«','#f8e1d9'),market:'Action'},
    {name:'Ayran 250ml',qty:4,unit:'Becher',cat:'GetrÃ¤nke',place:'KÃ¼hlschrank',mhd:plus(7),imgUrl:seedImage('ğŸ¥¤','#e8fff5'),market:'TÃ¼rkischer Markt'}
  ];
  for(const it of items){ await put({id:crypto.randomUUID(),...it,notes:''}); }
}

/* ====== Navigation ====== */
function go(where){
  window.scrollTo(0,0);
  home.hidden=inventoryPage.hidden=shopPage.hidden=dashPage.hidden=marketPage.hidden=true;
  if(where==='home'){ home.hidden=false; }
  if(where==='inventory'){ inventoryPage.hidden=false; renderInventory(); }
  if(where==='shop'){ shopPage.hidden=false; renderShop(); }
  if(where==='dashboard'){ dashPage.hidden=false; renderDash(); }
  if(where==='markets'){ marketPage.hidden=false; MARKET_STAGE='logos'; ACTIVE_MARKET=''; ACTIVE_MARKET_CAT=''; renderMarkets(); }
}

/* ====== Inventory (SB: Kategorien links) ====== */
async function renderInventory(){
  const all=await getAll();
  // Kategorien aufbauen
  const counts={'Alle':0}; all.forEach(it=>{ if(!it) return; const c=it.cat||'Sonstiges'; counts['Alle']++; counts[c]=(counts[c]||0)+1; });
  catList.innerHTML='';
  Object.keys(counts).sort((a,b)=>a==='Alle'?-1:b==='Alle'?1:a.localeCompare(b))
    .forEach(cat=>{
      const row=document.createElement('div'); row.className='cat'+(ACTIVE_CAT===cat?' active':'');
      row.innerHTML=`<span>${cat}</span><span>${counts[cat]}</span>`;
      row.onclick=()=>{ACTIVE_CAT=cat; renderInventory();};
      catList.appendChild(row);
    });
  // Produkte filtern
  const q=(qEl.value||'').toLowerCase();
  const items=all.filter(it=>{
    if(ACTIVE_CAT!=='Alle' && (it.cat||'Sonstiges')!==ACTIVE_CAT) return false;
    const hay=[it.name,it.cat,it.market,it.place,it.notes].filter(Boolean).join(' ').toLowerCase();
    return !q || hay.includes(q);
  }).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  invGrid.innerHTML=''; invEmpty.hidden=items.length>0;
  for(const it of items){
    const d=daysUntil(it.mhd);
    const card=document.createElement('div'); card.className='tile'; card.dataset.id=it.id;
    const img=document.createElement('img'); img.src=it.imgUrl||''; img.onerror=()=>img.src=seedImage('ğŸ“¦','#eee');
    const imgw=document.createElement('div'); imgw.className='imgwrap'; imgw.appendChild(img); card.appendChild(imgw);
    if(d!==null){ const rib=document.createElement('div'); rib.className='ribbon'+(d<0?' exp':''); rib.textContent=d<0?'Abgelaufen':(d<=14?'Bald':''); if(rib.textContent) card.appendChild(rib); }
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`<div class="name">${it.name||''}</div><div class="meta">${it.qty||0} ${it.unit||''} Â· ${(it.market||'â€”')}</div>`;
    card.appendChild(body);
    card.onclick=()=>openDialog(it);
    invGrid.appendChild(card);
  }
}

/* ====== Shopping ====== */
async function renderShop(){
  const all=await getAll(); const needs=all.filter(it=>(it.qty||0)===0);
  if(needs.length===0){ shopList.innerHTML='<div class="stat">Alles da âœ…</div>'; return; }
  const groups={}; for(const it of needs){ const m=it.market||'Allgemein'; (groups[m]=groups[m]||[]).push(it); }
  shopList.innerHTML='';
  for(const [market,arr] of Object.entries(groups)){
    const box=document.createElement('div'); box.className='stat';
    box.innerHTML=`<b>${market}</b>`;
    arr.forEach(it=>{
      const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px'; row.style.marginTop='8px';
      row.innerHTML=`<img src="${it.imgUrl||''}" onerror="this.src=''" style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:1px solid #eee"> ${it.name}`;
      const ok=document.createElement('button'); ok.className='ghost2'; ok.textContent='âœ… gekauft';
      ok.onclick=async()=>{ it.qty=1; await put(it); renderShop(); renderInventory(); };
      row.appendChild(ok); box.appendChild(row);
    });
    shopList.appendChild(box);
  }
}

/* ====== Dashboard ====== */
async function renderDash(){
  const all=await getAll();
  const soon=all.filter(it=>{const d=daysUntil(it.mhd); return d!==null && d>=0 && d<=14;});
  const exp =all.filter(it=>{const d=daysUntil(it.mhd); return d!==null && d<0;});
  soonList.innerHTML = soon.length? soon.map(i=>'â€¢ '+i.name+' ('+(i.mhd||'')+')').join('<br>') : 'â€”';
  expList.innerHTML  = exp.length ? exp.map(i=>'â€¢ '+i.name+' ('+(i.mhd||'')+')').join('<br>')  : 'â€”';
  totalStat.textContent = 'Produkte gesamt: '+all.length;
}

/* ====== Markets (3 Stufen) ====== */
const MARKET_LOGOS=[
  {name:'Lidl', icon:'ğŸŸ¦'}, {name:'Aldi', icon:'ğŸ”·'}, {name:'Rewe', icon:'ğŸŸ¥'},
  {name:'Action', icon:'ğŸŸ£'}, {name:'TÃ¼rkischer Markt', icon:'ğŸ•Œ'}
];
const MARKET_CATS=['GetrÃ¤nke','SÃ¼ÃŸwaren','Backwaren','GemÃ¼se/Obst','Fleisch/Fisch','TiefkÃ¼hl','Milchprodukte','Nudeln/Reis','Sonstiges'];

function renderMarkets(){
  marketEmpty.hidden=true; marketStageGrid.innerHTML='';
  marketBack.hidden = (MARKET_STAGE==='logos');
  if(MARKET_STAGE==='logos'){
    MARKET_LOGOS.forEach(m=>{
      const card=document.createElement('div'); card.className='tile';
      card.innerHTML=`<div class="imgwrap" style="font-size:48px">${m.icon}</div><div class="body"><div class="name">${m.name}</div></div>`;
      card.onclick=()=>{ ACTIVE_MARKET=m.name; MARKET_STAGE='cats'; renderMarkets(); };
      marketStageGrid.appendChild(card);
    });
  } else if(MARKET_STAGE==='cats'){
    MARKET_CATS.forEach(cat=>{
      const card=document.createElement('div'); card.className='tile';
      card.innerHTML=`<div class="imgwrap">${cat.startsWith('GetrÃ¤nke')?'ğŸ¥¤':cat.startsWith('SÃ¼ÃŸ')?'ğŸ«':cat.startsWith('Back')?'ğŸ':cat.startsWith('GemÃ¼se')?'ğŸ¥¬':cat.startsWith('Fleisch')?'ğŸ¥©':cat.startsWith('Tief')?'â„ï¸':cat.startsWith('Milch')?'ğŸ¥›':cat.startsWith('Nudeln')?'ğŸ':'ğŸ“¦'}</div><div class="body"><div class="name">${cat}</div><div class="meta">${ACTIVE_MARKET}</div></div>`;
      card.onclick=()=>{ ACTIVE_MARKET_CAT=cat; MARKET_STAGE='items'; renderMarkets(); };
      marketStageGrid.appendChild(card);
    });
  } else if(MARKET_STAGE==='items'){
    // Filter Produkte zu Market + Cat
    getAll().then(all=>{
      const items=all.filter(it=>(it.market||'')===ACTIVE_MARKET && (it.cat||'Sonstiges')===ACTIVE_MARKET_CAT);
      if(items.length===0){ marketEmpty.hidden=false; marketStageGrid.innerHTML=''; return; }
      items.forEach(it=>{
        const card=document.createElement('div'); card.className='tile'; card.innerHTML=`<div class="imgwrap"><img src="${it.imgUrl||''}" onerror="this.src=''" /></div><div class="body"><div class="name">${it.name}</div><div class="meta">${it.qty||0} ${it.unit||''}</div></div>`;
        card.onclick=()=>openDialog(it);
        marketStageGrid.appendChild(card);
      });
    });
  }
}
marketBack.onclick=()=>{ if(MARKET_STAGE==='items'){MARKET_STAGE='cats';} else if(MARKET_STAGE==='cats'){MARKET_STAGE='logos';} renderMarkets(); };

/* ====== Dialog: Add/Edit/Delete ====== */
function openDialog(it){
  form.reset(); delBtn.hidden=true; dlgTitle.textContent='Produkt hinzufÃ¼gen';
  if(it && it.id){ dlgTitle.textContent='Produkt bearbeiten'; delBtn.hidden=false; for(const [k,v] of Object.entries(it)){ if(form.elements[k]!==undefined) form.elements[k].value=v??''; } }
  dlg.showModal();
  delBtn.onclick=async()=>{ if(!it?.id) return; if(confirm('Wirklich lÃ¶schen?')){ await delItem(it.id); dlg.close(); renderInventory(); if(marketPage.hidden===false && MARKET_STAGE==='items') renderMarkets(); } };
}
document.getElementById('addBtn').onclick=()=>openDialog();
saveBtn.onclick=async()=>{
  const fd=new FormData(form);
  const item={
    id:fd.get('id')||crypto.randomUUID(),
    name:(fd.get('name')||'').trim(),
    qty:Number(fd.get('qty')||0),
    unit:(fd.get('unit')||'').trim(),
    cat:(fd.get('cat')||'').trim()||'Sonstiges',
    market:(fd.get('market')||'').trim(),
    place:(fd.get('place')||fd.get('place')||'Vorratsschrank'),
    mhd:fd.get('mhd')||'',
    imgUrl:(fd.get('imgUrl')||'').trim(),
    notes:(fd.get('notes')||'').trim()
  };
  if(!item.name){ alert('Name fehlt'); return; }
  await put(item);
  dlg.close();
  if(!inventoryPage.hidden) renderInventory();
  if(!marketPage.hidden && MARKET_STAGE==='items') renderMarkets();
  if(!shopPage.hidden) renderShop();
  if(!dashPage.hidden) renderDash();
};

/* ====== INIT ====== */
(async function init(){
  await openDB(); await seedIfEmpty();
  go('home'); // Start
})();
</script>
</body>
</html>
