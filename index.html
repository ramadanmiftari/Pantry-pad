<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pantry Pad – SB-Layout</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--shadow:0 8px 22px rgba(0,0,0,.08);--brand:#6a5cff;--brand2:#20c997;--danger:#ff6b6b}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}
button{cursor:pointer}
[hidden]{display:none!important}

/* HOME */
.home{min-height:100vh;display:grid;gap:22px;place-content:center;padding:26px;background:linear-gradient(135deg,#6a5cff,#20c997);color:#fff;text-align:center}
.choices{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));width:min(900px,96vw);margin:0 auto}
.choice{display:flex;align-items:center;gap:12px;padding:18px;border-radius:16px;border:none;background:#fff;color:#222;box-shadow:var(--shadow);font-size:1.05rem}
.choice .icon{font-size:1.6rem}

/* HEADER */
header{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
header h1{margin:0;font-size:1.1rem}
header input{padding:8px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem}
header .ghost{background:#fff;color:#333;border:1px solid var(--line);padding:8px 12px;border-radius:10px}
header .primary{background:var(--brand);color:#fff;border:none;padding:8px 12px;border-radius:10px}

/* LAYOUT */
.wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 60px)}
aside{background:#fff;border-right:1px solid var(--line);padding:12px}
.aside-title{font-weight:700;margin:4px 0 10px}
.cat-list{display:flex;flex-direction:column;gap:8px}
.cat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fafafa;cursor:pointer}
.cat.active{background:#eaf2ff;border-color:#6a5cff;font-weight:700}
main{padding:14px}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.tile{background:var(--card);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--line);cursor:pointer}
.imgwrap{width:100%;aspect-ratio:1/1;background:#eee;display:grid;place-items:center;overflow:hidden}
.tile img{width:100%;height:100%;object-fit:cover}
.body{padding:12px}
.name{font-weight:800}
.meta{font-size:.92rem;color:#555;margin-top:4px}
.ribbon{position:absolute;top:10px;left:10px;background:#fff3cd;color:#7a4e00;padding:4px 6px;border-radius:8px;font-size:.8rem}
.ribbon.exp{background:#fde2e0;color:#8b1a1a}
.empty{padding:40px;text-align:center;color:#777}

/* STAT */
.page{padding:16px}
.stat{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}

/* DIALOG */
dialog{width:min(560px,96vw);border:none;border-radius:16px;padding:0;box-shadow:var(--shadow)}
dialog header,dialog footer{padding:12px 16px}
dialog form{padding:16px;display:grid;gap:10px}
dialog input,dialog select{padding:10px;border:1px solid var(--line);border-radius:10px}
dialog footer{display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line)}
.primary{background:var(--brand2);color:#fff;border:none;padding:10px 12px;border-radius:10px}
.ghost2{background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:10px}
.danger{background:var(--danger);color:#fff;border:none;padding:10px 12px;border-radius:10px}
</style>
</head>
<body>

<!-- HOME -->
<section id="home" class="home">
  <h1>👋 Willkommen im Pantry Pad</h1>
  <div class="choices">
    <button class="choice" onclick="go('inventory')"><span class="icon">👀</span>Nachschauen</button>
    <button class="choice" onclick="go('shop')"><span class="icon">🛒</span>Einkaufsliste</button>
    <button class="choice" onclick="go('dashboard')"><span class="icon">📊</span>Dashboard</button>
    <button class="choice" onclick="go('markets')"><span class="icon">🏪</span>Supermärkte</button>
  </div>
</section>

<!-- INVENTORY -->
<section id="inventory" hidden>
  <header>
    <button class="ghost" onclick="go('home')">🏠</button>
    <h1 style="margin-right:auto">📦 Nachschauen</h1>
    <input id="q" placeholder="Suchen …" oninput="renderInventory()">
    <button class="primary" id="addBtn">+ Produkt</button>
  </header>
  <div class="wrap">
    <aside>
      <div class="aside-title">Kategorien</div>
      <div id="catList" class="cat-list"></div>
    </aside>
    <main>
      <div id="invGrid" class="grid"></div>
      <div id="invEmpty" class="empty" hidden>Keine Produkte. Mit „+ Produkt“ hinzufügen.</div>
    </main>
  </div>
</section>

<!-- SHOP -->
<section id="shop" class="page" hidden>
  <header><button class="ghost" onclick="go('home')">🏠</button><h1>🛒 Einkaufsliste</h1></header>
  <div class="stat"><b>❌ Fehlend</b><div id="shopMissing"></div></div>
  <div class="stat"><b>🛒 Warenkorb</b><div id="shopCart"></div></div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="page" hidden>
  <header><button class="ghost" onclick="go('home')">🏠</button><h1>📊 Dashboard</h1></header>
  <div class="stat"><b>⚠️ Bald ablaufend</b><div id="soonList"></div></div>
  <div class="stat"><b>❌ Abgelaufen</b><div id="expList"></div></div>
  <div class="stat"><b>📦 Gesamt</b><div id="totalStat"></div></div>
</section>

<!-- MARKETS -->
<section id="markets" class="page" hidden>
  <header><button class="ghost" onclick="go('home')">🏠</button><h1>🏪 Supermärkte</h1><button class="ghost" id="marketBack" hidden>⬅️ Zurück</button></header>
  <div id="marketStageGrid" class="grid"></div>
  <div id="marketEmpty" class="empty" hidden>Keine Produkte.</div>
</section>

<!-- DIALOG -->
<dialog id="dlg">
  <header><strong id="dlgTitle">Produkt</strong></header>
  <form id="form">
    <input type="hidden" name="id">
    <input name="name" placeholder="Name" required>
    <input name="qty" type="number" placeholder="Menge" value="1">
    <input name="unit" placeholder="Einheit">
    <select name="cat"><option>Backwaren</option><option>Getränke</option><option>Süßwaren</option><option>Nudeln/Reis</option><option>Milchprodukte</option><option>Sonstiges</option></select>
    <select name="market"><option>Lidl</option><option>Aldi</option><option>Rewe</option><option>Action</option><option>Türkischer Markt</option></select>
    <input name="mhd" type="date">
    <input name="imgUrl" placeholder="Bild-URL">
  </form>
  <footer>
    <button id="delBtn" class="danger" hidden>🗑️ Löschen</button>
    <button class="ghost2" onclick="dlg.close()">Abbrechen</button>
    <button id="saveBtn" class="primary">Speichern</button>
  </footer>
</dialog>

<script>
/* DB Setup */
let db; const DB='pantry', STORE='items';
const openDB=()=>new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE,{keyPath:'id'});r.onsuccess=()=>{db=r.result;res();}});
const st=(m='readonly')=>db.transaction(STORE,m).objectStore(STORE);
const getAll=()=>new Promise(r=>{const q=st().getAll();q.onsuccess=()=>r(q.result||[]);});
const put=(it)=>new Promise(r=>{st('readwrite').put(it).onsuccess=()=>r();});
const delItem=(id)=>new Promise(r=>{st('readwrite').delete(id).onsuccess=()=>r();});

/* Navigation */
function go(id){['home','inventory','shop','dashboard','markets'].forEach(x=>document.getElementById(x).hidden=true);document.getElementById(id).hidden=false;if(id==='inventory')renderInventory();if(id==='shop')renderShop();if(id==='dashboard')renderDash();if(id==='markets'){MARKET_STAGE='logos';renderMarkets();}}

/* Inventory */
let ACTIVE_CAT='Alle';
async function renderInventory(){
  const all=await getAll();
  const cats=['Alle',...new Set(all.map(i=>i.cat||'Sonstiges'))];
  const catList=document.getElementById('catList');catList.innerHTML='';
  cats.forEach(c=>{const div=document.createElement('div');div.className='cat'+(c===ACTIVE_CAT?' active':'');div.textContent=c;div.onclick=()=>{ACTIVE_CAT=c;renderInventory();};catList.appendChild(div);});
  const q=(document.getElementById('q').value||'').toLowerCase();
  const items=all.filter(i=>(ACTIVE_CAT==='Alle'||i.cat===ACTIVE_CAT)&&(!q||i.name.toLowerCase().includes(q)));
  const grid=document.getElementById('invGrid');grid.innerHTML='';document.getElementById('invEmpty').hidden=items.length>0;
  items.forEach(it=>{const d=it.mhd?Math.floor((new Date(it.mhd)-new Date())/86400000):null;
    const card=document.createElement('div');card.className='tile';card.innerHTML=`<div class="imgwrap"><img src="${it.imgUrl||''}" onerror="this.src='https://via.placeholder.com/150'"></div>${d!==null?(d<0?'<div class="ribbon exp">Abgelaufen</div>':d<=14?'<div class="ribbon">Bald</div>':''):''}<div class="body"><div class="name">${it.name}</div><div class="meta">${it.qty||0} ${it.unit||''}</div></div>`;card.onclick=()=>openDialog(it);grid.appendChild(card);});
}

/* Shop */
async function renderShop(){
  const all=await getAll();const missing=all.filter(i=>(i.qty||0)===0);
  const m=document.getElementById('shopMissing');const c=document.getElementById('shopCart');m.innerHTML='';c.innerHTML='';
  if(!missing.length){m.innerHTML='Alles da ✅';return;}
  missing.forEach(it=>{const row=document.createElement('div');row.style.display='flex';row.style.alignItems='center';row.style.gap='10px';row.innerHTML=`<img src="${it.imgUrl||''}" onerror="this.src='https://via.placeholder.com/40'" style="width:40px;height:40px"> ${it.name}`;const box=document.createElement('input');box.type='checkbox';box.onchange=()=>{if(box.checked){const newRow=row.cloneNode(true);newRow.querySelector('input')?.remove();const btn=document.createElement('button');btn.textContent='✅ Gekauft';btn.onclick=async()=>{it.qty=1;await put(it);renderShop();renderInventory();};newRow.appendChild(btn);c.appendChild(newRow);row.remove();}};row.appendChild(box);m.appendChild(row);});
}

/* Dashboard */
async function renderDash(){const all=await getAll();const soon=all.filter(i=>{const d=i.mhd?Math.floor((new Date(i.mhd)-new Date())/86400000):null;return d!==null&&d>=0&&d<=14;});const exp=all.filter(i=>i.mhd&&new Date(i.mhd)<new Date());soonList.innerHTML=soon.map(i=>'• '+i.name).join('<br>')||'—';expList.innerHTML=exp.map(i=>'• '+i.name).join('<br>')||'—';totalStat.textContent='Produkte: '+all.length;}

/* Markets */
let MARKET_STAGE='logos',ACTIVE_MARKET='',ACTIVE_CAT_M='';
const MARKET_LOGOS=[{n:'Lidl',i:'🟦'},{n:'Aldi',i:'🔷'},{n:'Rewe',i:'🟥'},{n:'Action',i:'🟣'},{n:'Türkischer Markt',i:'🕌'}];
const MARKET_CATS=['Getränke','Süßwaren','Backwaren','Milchprodukte','Nudeln/Reis','Sonstiges'];
function renderMarkets(){marketStageGrid.innerHTML='';marketBack.hidden=(MARKET_STAGE==='logos');
  if(MARKET_STAGE==='logos'){MARKET_LOGOS.forEach(m=>{const card=document.createElement('div');card.className='tile';card.innerHTML=`<div class="imgwrap" style="font-size:48px">${m.i}</div><div class="body"><div class="name">${m.n}</div></div>`;card.onclick=()=>{ACTIVE_MARKET=m.n;MARKET_STAGE='cats';renderMarkets();};marketStageGrid.appendChild(card);});}
  else if(MARKET_STAGE==='cats'){MARKET_CATS.forEach(cat=>{const card=document.createElement('div');card.className='tile';card.innerHTML=`<div class="imgwrap">📦</div><div class="body"><div class="name">${cat}</div></div>`;card.onclick=()=>{ACTIVE_CAT_M=cat;MARKET_STAGE='items';renderMarkets();};marketStageGrid.appendChild(card);});}
  else if(MARKET_STAGE==='items'){getAll().then(all=>{const items=all.filter(i=>i.market===ACTIVE_MARKET&&i.cat===ACTIVE_CAT_M);if(!items.length){marketEmpty.hidden=false;return;}marketEmpty.hidden=true;items.forEach(it=>{const card=document.createElement('div');card.className='tile';card.innerHTML=`<div class="imgwrap"><img src="${it.imgUrl||''}" onerror="this.src='https://via.placeholder.com/150'"></div><div class="body"><div class="name">${it.name}</div></div>`;marketStageGrid.appendChild(card);});});}}
marketBack.onclick=()=>{MARKET_STAGE=(MARKET_STAGE==='items'?'cats':'logos');renderMarkets();};

/* Dialog */
const dlg=document.getElementById('dlg');const form=document.getElementById('form');const delBtn=document.getElementById('delBtn');
function openDialog(it){form.reset();delBtn.hidden=!it;document.getElementById('dlgTitle').textContent=it?'Produkt bearbeiten':'Produkt hinzufügen';if(it)Object.entries(it).forEach(([k,v])=>{if(form[k])form[k].value=v;});dlg.showModal();delBtn.onclick=async()=>{await delItem(it.id);dlg.close();renderInventory();renderShop();};}
document.getElementById('addBtn').onclick=()=>openDialog();
document.getElementById('saveBtn').onclick=async()=>{const fd=new FormData(form);const item=Object.fromEntries(fd.entries());item.id=item.id||crypto.randomUUID();item.qty=Number(item.qty||0);await put(item);dlg.close();renderInventory();renderShop();renderDash();};

/* Init */
(async()=>{await openDB();go('home');})();
