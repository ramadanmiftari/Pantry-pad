<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pantry Pad</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --line:#e5e7eb; --shadow:0 10px 28px rgba(0,0,0,.10);
  --radius:18px; --gap:14px; --brand:#6a5cff; --brand2:#20c997; --warn:#ffcc66; --danger:#ff8a80;
}
*{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}

/* ===== HOME (KIOSK) ===== */
.home{min-height:100vh;display:grid;gap:22px;grid-auto-rows:min-content;place-content:center;padding:26px;background:linear-gradient(135deg,#6a5cff 0%,#20c997 100%);color:#fff;text-align:center}
.home h1{margin:0 0 6px;font-size:1.9rem}
.subtitle{opacity:.9;margin:0 0 12px}
.choices{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));width:min(1000px,96vw);margin:0 auto}
.choice{display:flex;align-items:center;gap:12px;padding:18px;border-radius:16px;border:none;cursor:pointer;background:#fff;color:#222;box-shadow:0 10px 28px rgba(0,0,0,.12);font-size:1.05rem;text-align:left}
.choice .icon{font-size:1.6rem}
.choice.view{border-left:10px solid var(--brand2)}
.choice.edit{border-left:10px solid var(--brand)}
.choice.shop{border-left:10px solid #ff7ab6}
.choice.book{border-left:10px solid #ffa94d}
.choice.dash{border-left:10px solid #66d9e8}
.choice.market{border-left:10px solid #ffd43b}

/* ===== APP SHELL ===== */
header{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:8}
header h1{margin:0;font-size:1.1rem}
header input,header select{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem}
header button{padding:10px 12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-size:1rem;white-space:nowrap}
header .ghost{background:#fff;color:#333;border:1px solid var(--line)}
.wrap{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 60px)}
aside{background:#fff;border-right:1px solid var(--line);padding:12px}
.aside-title{font-weight:600;margin:4px 0 10px 2px}
.cat-list{display:flex;flex-direction:column;gap:8px}
.cat{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;cursor:pointer}
.cat.active{background:#eaf2ff;border-color:#bcd4ff}
main{padding:14px}
.grid{display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.tile{position:relative;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--line)}
.imgwrap{width:100%;aspect-ratio:1/1;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden}
.tile img{width:100%;height:100%;object-fit:cover}
.body{padding:12px}
.name{font-weight:700;line-height:1.2}
.meta{font-size:.92rem;color:#555;margin-top:6px}
.ribbon{position:absolute;top:10px;left:10px;padding:6px 8px;border-radius:10px;font-size:.8rem;background:#fff3cd;color:#7a4e00;box-shadow:var(--shadow)}
.ribbon.exp{background:#fde2e0;color:#8b1a1a}
.quick{display:flex;gap:6px;margin-top:10px}
.quick button{flex:1;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px}
.footerbar{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:#fff;position:sticky;bottom:0;z-index:7}
.footerbar small{color:#666;margin-left:auto}
.empty{text-align:center;color:#777;padding:40px}

/* ===== PAGES (shoplist, cookbook, dashboard, markets) ===== */
.page{padding:16px}
.section-title{font-weight:800;margin:10px 0 12px;font-size:1.2rem}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f3f5;border:1px solid #e9ecef;margin-left:6px}

/* ===== Dialog ===== */
dialog{width:min(560px,96vw);border:none;border-radius:18px;padding:0;box-shadow:var(--shadow)}
dialog header,dialog footer{padding:12px 16px}
dialog header{border-bottom:1px solid var(--line)}
dialog form{padding:16px;display:grid;gap:10px}
dialog input,dialog textarea,dialog select{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem}
dialog footer{border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
.danger{background:var(--danger);color:#fff;border:none}
.primary{background:var(--brand2);color:#fff;border:none}
.ghost2{background:#fff;border:1px solid var(--line)}

/* ===== AI Twins Widget ===== */
.ai-bubble{position:fixed;right:14px;bottom:14px;z-index:9;display:flex;align-items:flex-end;gap:8px}
.ai-card{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:10px 12px;max-width:56vw}
.ai-avatar{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;overflow:hidden;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.ai-msg{font-size:.95rem}
.ai-small{font-size:.8rem;color:#666;margin-top:2px}
.toggleRow{display:flex;gap:8px;align-items:center}

/* In-App Notifications (fallback) */
.notice{position:fixed;left:50%;transform:translateX(-50%);top:10px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:14px;padding:10px 14px;z-index:9;display:flex;gap:10px;align-items:center}
.notice img{width:40px;height:40px;border-radius:8px;object-fit:cover}
</style>
</head>
<body>

<!-- ===== HOME ===== -->
<section id="home" class="home">
  <div>
    <h1>üëã Willkommen im Pantry Pad</h1>
    <p class="subtitle">Was m√∂chtest du tun?</p>
    <div class="choices">
      <button class="choice view"  data-go="inventory-view"><span class="icon">üëÄ</span><span><strong>Nachschauen</strong><br><small>Best√§nde ansehen</small></span></button>
      <button class="choice edit"  data-go="inventory-edit"><span class="icon">‚úèÔ∏è</span><span><strong>Bearbeiten</strong><br><small>Produkte hinzuf√ºgen & √§ndern</small></span></button>
      <button class="choice shop"  data-go="shop"><span class="icon">üõí</span><span><strong>Einkaufsliste</strong><br><small>Fehlendes abhaken</small></span></button>
      <button class="choice book"  data-go="cookbook"><span class="icon">üìñ</span><span><strong>Kochbuch</strong><br><small>Mit Video & Zutatencheck</small></span></button>
      <button class="choice dash"  data-go="dashboard"><span class="icon">üìä</span><span><strong>Dashboard</strong><br><small>√úberblick & Warnungen</small></span></button>
      <button class="choice market" data-go="markets"><span class="icon">üè™</span><span><strong>Superm√§rkte</strong><br><small>Lidl, Aldi, Rewe, Action ‚Ä¶</small></span></button>
    </div>
    <div style="margin-top:16px" class="toggleRow">
      <select id="langHome" style="padding:10px 12px;border-radius:10px;border:1px solid #ddd">
        <option value="de">Deutsch</option><option value="en">English</option><option value="tr">T√ºrk√ße</option>
      </select>
      <button id="installBtn" class="choice" style="padding:10px 12px">üì≤ Zum Home-Bildschirm</button>
      <button id="notifBtn" class="choice" style="padding:10px 12px">üîî Benachrichtigungen erlauben</button>
    </div>
  </div>
</section>

<!-- ===== APP FRAME (Inventory) ===== -->
<section id="app" hidden>
  <header>
    <button id="backHome" class="ghost">üè† Start</button>
    <h1 id="appTitle" style="min-width:120px">Pantry Pad</h1>
    <input id="q" placeholder="Suchen ‚Ä¶"/>
    <select id="locFilter" style="flex:0 0 auto">
      <option value="">Alle Orte</option>
      <option>Vorratsschrank</option><option>K√ºhlschrank</option><option>Gefrierfach</option>
    </select>
    <button id="add">+ Produkt</button>
    <select id="lang" style="flex:0 0 auto">
      <option value="de">DE</option><option value="en">EN</option><option value="tr">TR</option>
    </select>
  </header>

  <div class="wrap">
    <aside>
      <div class="aside-title" id="catTitle">Kategorien</div>
      <div class="cat-list" id="cats"></div>
    </aside>
    <main>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" hidden>Keine Produkte. Tippe auf ‚Äû+ Produkt‚Äú.</div>
    </main>
  </div>

  <div class="footerbar">
    <button id="export" class="ghost2">‚¨áÔ∏è Export</button>
    <button id="importBtn" class="ghost2">‚¨ÜÔ∏è Import</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <label id="warnLabel">Warnung in
      <input id="soonDays" type="number" min="1" max="90" value="14" style="width:64px;margin:0 6px"> Tagen
    </label>
    <small id="offlineNote">Speicher: lokal ¬∑ Offline m√∂glich</small>
  </div>
</section>

<!-- ===== SHOPPING LIST ===== -->
<section id="shopPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">üè† Start</button>
    <h1 style="margin:0 8px 0 8px">üõí Einkaufsliste</h1>
    <button class="ghost" onclick="rebuildShopList()">üîÅ Aktualisieren</button>
  </header>
  <div id="shopList"></div>
</section>

<!-- ===== COOKBOOK ===== -->
<section id="cookPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">üè† Start</button>
    <h1 style="margin:0 8px 0 8px">üìñ Kochbuch</h1>
  </header>
  <div id="recipesGrid" class="grid"></div>
  <div id="recipeDetail" hidden class="stat" style="margin-top:16px"></div>
</section>

<!-- ===== DASHBOARD ===== -->
<section id="dashPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">üè† Start</button>
    <h1 style="margin:0 8px 0 8px">üìä Dashboard</h1>
  </header>
  <div class="kv">
    <div class="stat"><strong>‚ö†Ô∏è Bald ablaufend</strong><div id="soonList"></div></div>
    <div class="stat"><strong>‚ùå Abgelaufen</strong><div id="expList"></div></div>
    <div class="stat"><strong>üì¶ Gesamt</strong><div id="totalStat"></div></div>
    <div class="stat"><strong>üßä Orte</strong><div id="placeStat"></div></div>
  </div>
</section>

<!-- ===== MARKETS ===== -->
<section id="marketPage" class="page" hidden>
  <header>
    <button class="ghost" onclick="go('home')">üè† Start</button>
    <h1 style="margin:0 8px 0 8px">üè™ Superm√§rkte</h1>
  </header>
  <div class="grid" id="marketGrid"></div>
</section>

<!-- ===== PRODUCT DIALOG ===== -->
<dialog id="dlg">
  <header><strong id="dlgTitle">Produkt</strong></header>
  <form method="dialog" id="form">
    <input name="id" type="hidden">
    <input name="name" placeholder="Name (z. B. Mehl 405)" required>
    <div style="display:flex;gap:8px">
      <input name="qty" type="number" step="1" min="0" placeholder="Menge" required>
      <input name="unit" placeholder="Einheit (Stk, kg, L ‚Ä¶)" value="Stk">
      <input name="cat" placeholder="Kategorie (z. B. S√º√üwaren)">
    </div>
    <div style="display:flex;gap:8px">
      <input name="mhd" type="date" placeholder="MHD">
      <select name="place">
        <option value="">Ort w√§hlen</option><option>Vorratsschrank</option><option>K√ºhlschrank</option><option>Gefrierfach</option>
      </select>
    </div>
    <textarea name="notes" rows="2" placeholder="Notizen (optional)"></textarea>
    <div style="display:grid;gap:8px">
      <div id="photoLabel" style="font-weight:600">Foto</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input name="imgurl" placeholder="Bild-URL (optional)" style="flex:1">
        <input id="imgfile" type="file" accept="image/*" capture="environment">
      </div>
      <img id="preview" alt="Preview" style="width:100%;max-height:240px;object-fit:contain;background:#f2f2f2;border:1px solid #e5e7eb;border-radius:10px">
    </div>
  </form>
  <footer>
    <button id="del" class="danger">L√∂schen</button>
    <button id="cancel" class="ghost2">Abbrechen</button>
    <button id="save" class="primary">Speichern</button>
  </footer>
</dialog>

<!-- ===== AI TWINS (Ilyan & Liaz) ===== -->
<div class="ai-bubble" id="aiTwins" hidden>
  <div class="ai-card">
    <div class="ai-avatar" id="avIlyan"></div>
    <div class="ai-msg">
      <div><strong>Ilyan</strong></div>
      <div id="msgIlyan">Hallo! Ich helfe beim MHD üëÄ</div>
    </div>
  </div>
  <div class="ai-card">
    <div class="ai-avatar" id="avLiaz"></div>
    <div class="ai-msg">
      <div><strong>Liaz</strong></div>
      <div id="msgLiaz">Hi! Ich k√ºmmere mich um die Einkaufsliste üõí</div>
      <div class="ai-small"><button class="ghost2" id="ttsBtn">üîä Vorlesen</button></div>
    </div>
  </div>
</div>

<!-- ===== In-App notice fallback ===== -->
<div id="notice" class="notice" hidden>
  <img id="noticeImg" alt="">
  <div id="noticeText">Hinweis</div>
</div>

<script>
/* ========== I18N (kurz) ========== */
const I18N={
  de:{title:'Pantry Pad',search:'Suchen ‚Ä¶',add:'+ Produkt',cats:'Kategorien',none:'Keine Produkte. Tippe auf ‚Äû+ Produkt‚Äú.','expired':'Abgelaufen',soon:n=>`Bald (${n}T)`,qtyUnit:(q,u)=>`${q} ${u||''}`,mhd:d=>`MHD: ${d}`,shop:'Einkaufsliste',cookbook:'Kochbuch',dashboard:'Dashboard',markets:'Superm√§rkte'},
  en:{title:'Pantry Pad',search:'Search ‚Ä¶',add:'+ Item',cats:'Categories',none:'No items. Tap ‚Äú+ Item‚Äù.','expired':'Expired',soon:n=>`Soon (${n}d)`,qtyUnit:(q,u)=>`${q} ${u||''}`,mhd:d=>`Exp: ${d}`,shop:'Shopping',cookbook:'Cookbook',dashboard:'Dashboard',markets:'Markets'},
  tr:{title:'Kiler Paneli',search:'Ara ‚Ä¶',add:'+ √úr√ºn',cats:'Kategoriler',none:'√úr√ºn yok. ‚Äú+ √úr√ºn‚Äùe dokun.','expired':'S√ºresi ge√ßti',soon:n=>`Yakƒ±nda (${n}g)`,qtyUnit:(q,u)=>`${q} ${u||''}`,mhd:d=>`SKT: ${d}`,shop:'Alƒ±≈üveri≈ü',cookbook:'Yemek kitabƒ±',dashboard:'G√∂sterge',markets:'Marketler'}
};
let LANG=localStorage.getItem('pantry-lang')||'de';
/* ========== DB ========== */
const DB='pantry-db-v2', STORE='items'; let db;
const openDB=()=>new Promise((res,rej)=>{const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>r.result.createObjectStore(STORE,{keyPath:'id'}); r.onsuccess=()=>{db=r.result;res();}; r.onerror=()=>rej(r.error);});
const st=(m='readonly')=>db.transaction(STORE,m).objectStore(STORE);
const getAll=()=>new Promise((res,rej)=>{const q=st().getAll(); q.onsuccess=()=>res(q.result||[]); q.onerror=()=>rej(q.error);});
const put=(it)=>new Promise((res,rej)=>{const q=st('readwrite').put(it); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error);});
const delItem=(id)=>new Promise((res,rej)=>{const q=st('readwrite').delete(id); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error);});
/* ========== Refs & State ========== */
const home=document.getElementById('home'), app=document.getElementById('app');
const qEl=document.getElementById('q'), addBtn=document.getElementById('add'), langSel=document.getElementById('lang'), langHome=document.getElementById('langHome');
const soonDays=document.getElementById('soonDays'), locFilter=document.getElementById('locFilter');
const catsEl=document.getElementById('cats'), grid=document.getElementById('grid'), emptyEl=document.getElementById('empty');
const backHome=document.getElementById('backHome'); const appTitle=document.getElementById('appTitle'); const catTitle=document.getElementById('catTitle');
const shopPage=document.getElementById('shopPage'), shopList=document.getElementById('shopList');
const cookPage=document.getElementById('cookPage'), recipesGrid=document.getElementById('recipesGrid'), recipeDetail=document.getElementById('recipeDetail');
const dashPage=document.getElementById('dashPage'); const soonList=document.getElementById('soonList'), expList=document.getElementById('expList'), totalStat=document.getElementById('totalStat'), placeStat=document.getElementById('placeStat');
const marketPage=document.getElementById('marketPage'), marketGrid=document.getElementById('marketGrid');
const ai=document.getElementById('aiTwins'), avI=document.getElementById('avIlyan'), avL=document.getElementById('avLiaz'), msgI=document.getElementById('msgIlyan'), msgL=document.getElementById('msgLiaz'), ttsBtn=document.getElementById('ttsBtn');
const notice=document.getElementById('notice'), noticeImg=document.getElementById('noticeImg'), noticeText=document.getElementById('noticeText');
let ACTIVE_CAT='Alle', EDIT_MODE=false;
/* ========== Helpers ========== */
const esc=s=>s?.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))||'';
const daysUntil=ds=>{if(!ds) return null; const n=new Date(); n.setHours(0,0,0,0); const d=new Date(ds+'T00:00:00'); return Math.floor((d-n)/86400000);};
const fileToDataURL=f=>new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error); fr.readAsDataURL(f);});
/* ========== SEED (kleines Beispiel) ========== */
function seedImage(emoji,bg){const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%' height='100%' rx='40' ry='40' fill='${bg}'/><text x='50%' y='55%' text-anchor='middle' font-size='400'>${emoji}</text></svg>`);return `data:image/svg+xml;charset=utf-8,${svg}`;}
async function seedIfEmpty(){
  const all=await getAll(); if(all.length) return;
  const plus=d=>{const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10);};
  const items=[
    {name:'Sonnenblumen√∂l 1L',qty:2,unit:'Fl',cat:'üè™ Lidl',place:'Vorratsschrank',mhd:plus(60),imgData:seedImage('üü°','#fff3cd')},
    {name:'Mehl 405 1kg',qty:3,unit:'kg',cat:'ü•£ Backmittel',place:'Vorratsschrank',mhd:plus(180),imgData:seedImage('üåæ','#e6f4ea')},
    {name:'Vollmilch 3,5%',qty:1,unit:'Pack',cat:'ü•õ Milchprodukte',place:'K√ºhlschrank',mhd:plus(3),imgData:seedImage('ü•õ','#e0f0ff')},
    {name:'Spaghetti 500g',qty:0,unit:'Pack',cat:'üçù Nudeln',place:'Vorratsschrank',mhd:plus(365),imgData:seedImage('üçù','#ffe8d6')},
    {name:'Schokolade 100g',qty:6,unit:'Tafeln',cat:'üç´ S√º√üwaren',place:'Vorratsschrank',mhd:plus(240),imgData:seedImage('üç´','#f8e1d9')},
    {name:'Mineralwasser 1,5L',qty:2,unit:'Fl',cat:'ü•§ Getr√§nke',place:'Vorratsschrank',mhd:plus(720),imgData:seedImage('üíß','#e0f7ff')}
  ];
  for(const it of items){await put({id:crypto.randomUUID(),...it,archived:false,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});}
}
/* ========== RENDER INVENTORY ========== */
async function render(){
  appTitle.textContent=I18N[LANG].title; document.title=I18N[LANG].title;
  qEl.placeholder=I18N[LANG].search; addBtn.textContent=I18N[LANG].add; document.getElementById('offlineNote').textContent='Speicher: lokal ¬∑ Offline m√∂glich'; catTitle.textContent=I18N[LANG].cats;
  const all=await getAll();
  // Kategorien
  const counts={ 'Alle': all.filter(i=>!i.archived).length };
  for(const it of all){ if(it.archived) continue; const c=(it.cat||'').trim()||'‚ü®ohne Kategorie‚ü©'; counts[c]=(counts[c]||0)+1; }
  catsEl.innerHTML='';
  Object.keys(counts).sort((a,b)=>a==='Alle'?-1:(b==='Alle'?1:a.localeCompare(b))).forEach(cat=>{
    const row=document.createElement('div'); row.className='cat'+((ACTIVE_CAT===cat)?' active':''); row.innerHTML=`<span>${esc(cat)}</span><span>${counts[cat]}</span>`;
    row.addEventListener('click',()=>{ACTIVE_CAT=cat; drawGrid(all);}); catsEl.appendChild(row);
  });
  drawGrid(all); // list
  // Dashboard preview lists
  buildDashboard(all);
  // Shopping list
  buildShop(all);
}
function drawGrid(all){
  const q=(qEl.value||'').toLowerCase();
  const loc=locFilter.value||'';
  const items=all.filter(it=>{
    const hay=[it.name,it.cat,it.notes,it.place].filter(Boolean).join(' ').toLowerCase();
    const passQ=!q||hay.includes(q);
    const passC=(ACTIVE_CAT==='Alle')||(((it.cat||'').trim()||'‚ü®ohne Kategorie‚ü©')===ACTIVE_CAT);
    const passL=!loc || (it.place||'')===loc;
    return passQ && passC && passL && !it.archived;
  }).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  grid.innerHTML=''; if(items.length===0){ emptyEl.hidden=false; emptyEl.textContent=I18N[LANG].none; return; } else emptyEl.hidden=true;

  for(const it of items){
    const d=daysUntil(it.mhd); const soon=d!==null && d>=0 && d<=Number(soonDays.value||14); const exp=d!==null && d<0;
    const card=document.createElement('div'); card.className='tile';
    const imgwrap=document.createElement('div'); imgwrap.className='imgwrap';
    const img=document.createElement('img'); const src=it.imgData||it.imgUrl||''; img.alt=it.name||''; if(src) img.src=src; else imgwrap.textContent='üì∑';
    imgwrap.appendChild(img); card.appendChild(imgwrap);
    if(soon||exp){ const r=document.createElement('div'); r.className='ribbon'+(exp?' exp':''); r.textContent=exp?I18N[LANG].expired:I18N[LANG].soon(d); card.appendChild(r); }
    const body=document.createElement('div'); body.className='body';
    const meta=[ I18N[LANG].qtyUnit(it.qty??0,it.unit||'') ]; if(it.mhd) meta.push(I18N[LANG].mhd(it.mhd)); if(it.cat) meta.push(it.cat); if(it.place) meta.push(it.place);
    body.innerHTML=`<div class="name">${esc(it.name||'')}</div><div class="meta">${esc(meta.join(' ¬∑ '))}</div>`;
    if(EDIT_MODE){
      const quick=document.createElement('div'); quick.className='quick';
      quick.append(btn('‚àí1',async()=>{it.qty=Math.max(0,(it.qty||0)-1); if(it.qty===0) it.archived=false; await put(it); render();}),
                   btn('+1',async()=>{it.qty=(it.qty||0)+1; it.archived=false; await put(it); render();}),
                   btn('Bearbeiten',()=>openDialog(it)),
                   btn('Zu Liste',async()=>{ if(it.qty>0){it.qty=0; await put(it);} go('shop'); await rebuildShopList(); })
      );
      body.appendChild(quick);
    }
    card.appendChild(body); grid.appendChild(card);
  }
}
const btn=(txt,fn)=>{const b=document.createElement('button'); b.textContent=txt; b.addEventListener('click',fn); return b;};

/* ========== DASHBOARD ========== */
function buildDashboard(all){
  const soon=all.filter(it=>{const d=daysUntil(it.mhd); return d!==null && d>=0 && d<=Number(soonDays.value||14) && !it.archived;});
  const exp =all.filter(it=>{const d=daysUntil(it.mhd); return d!==null && d<0 && !it.archived;});
  soonList.innerHTML = soon.length? soon.map(x=>`‚Ä¢ ${esc(x.name)} (${I18N[LANG].mhd(x.mhd)})`).join('<br>') : '‚Äî';
  expList.innerHTML  = exp.length ? exp.map(x=>`‚Ä¢ ${esc(x.name)} (${I18N[LANG].mhd(x.mhd)})`).join('<br>')  : '‚Äî';
  totalStat.innerHTML= `üì¶ ${all.filter(i=>!i.archived).length} Produkte <span class="badge">aktiv</span>`;
  const places={}; for(const it of all){ if(it.archived) continue; const p=it.place||'‚Äî'; places[p]=(places[p]||0)+1; }
  placeStat.innerHTML = Object.entries(places).map(([k,v])=>`‚Ä¢ ${esc(k)}: ${v}`).join('<br>') || '‚Äî';
}

/* ========== SHOPPING LIST ========== */
async function rebuildShopList(){ buildShop(await getAll()); }
function buildShop(all){
  const items = all.filter(i=>!i.archived && (Number(i.qty||0)===0));
  if(!shopList) return;
  if(items.length===0){ shopList.innerHTML='<p>Alles da ‚úÖ</p>'; return; }
  const groups={}; for(const it of items){ const m=(it.cat||'').includes('Lidl')?'Lidl':(it.cat||'').includes('Aldi')?'Aldi':(it.cat||'').includes('Rewe')?'Rewe':(it.cat||'').includes('Action')?'Action':'Allgemein'; (groups[m]=groups[m]||[]).push(it);}
  shopList.innerHTML='';
  for(const [market,arr] of Object.entries(groups)){
    const wrap=document.createElement('div'); wrap.className='stat'; wrap.style.marginBottom='10px';
    wrap.innerHTML=`<strong>${esc(market)}</strong>`;
    arr.forEach(it=>{
      const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px'; row.style.marginTop='8px';
      const img=document.createElement('img'); img.src=it.imgData||it.imgUrl||''; img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const label=document.createElement('div'); label.textContent=it.name;
      const ok=btn('‚úÖ gekauft', async()=>{ it.qty=1; await put(it); rebuildShopList(); render(); showNotice(it,'Gekauft'); });
      row.append(img,label,ok); wrap.appendChild(row);
    });
    shopList.appendChild(wrap);
  }
}

/* ========== COOKBOOK (Demo Daten + Matching) ========== */
const RECIPES=[
  { id:'r1', title:'Menemen (t√ºrkisches R√ºhrei)', servings:2, tags:['t√ºrkisch','schnell'], videoUrl:'https://www.youtube.com/results?search_query=menemen+sally',
    ingredients:[{name:'Eier',amount:3,unit:'Stk'},{name:'Tomaten',amount:2,unit:'Stk'},{name:'Paprika',amount:1,unit:'Stk'},{name:'√ñl',amount:1,unit:'EL'},{name:'Salz',amount:1,unit:'Prise'}]},
  { id:'r2', title:'B√∂rek mit K√§se', servings:4, tags:['t√ºrkisch','ofen'], videoUrl:'https://www.youtube.com/results?search_query=sally+b%C3%B6rek',
    ingredients:[{name:'Yufka',amount:3,unit:'Blatt'},{name:'Feta',amount:200,unit:'g'},{name:'Petersilie',amount:1,unit:'Bund'},{name:'Ei',amount:1,unit:'Stk'},{name:'Joghurt',amount:100,unit:'g'}]},
  { id:'r3', title:'Pfannkuchen', servings:2, tags:['s√º√ü','schnell'], videoUrl:'https://www.youtube.com/results?search_query=sally+pfannkuchen',
    ingredients:[{name:'Mehl',amount:200,unit:'g'},{name:'Milch',amount:300,unit:'ml'},{name:'Ei',amount:2,unit:'Stk'},{name:'Zucker',amount:1,unit:'EL'}]}
];
function normalize(s){return (s||'').toLowerCase()}
function hasIngredient(pantry,name){const n=normalize(name); return PANTRY_CACHE.some(it=>normalize(it.name).includes(n) && (it.qty||0)>0);}
let PANTRY_CACHE=[];
async function buildRecipes(){
  PANTRY_CACHE = await getAll();
  recipesGrid.innerHTML='';
  for(const r of RECIPES){
    const have=r.ingredients.filter(x=>hasIngredient(PANTRY_CACHE,x.name)).length;
    const pct=Math.round((have/r.ingredients.length)*100);
    const card=document.createElement('div'); card.className='tile';
    const imgwrap=document.createElement('div'); imgwrap.className='imgwrap'; imgwrap.textContent='üç≥';
    card.appendChild(imgwrap);
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`<div class="name">${esc(r.title)}</div><div class="meta">${pct}% Zutaten vorhanden ¬∑ <a target="_blank" href="${r.videoUrl}">‚ñ∂Ô∏è Video</a></div>`;
    const open=btn('Details',()=>showRecipe(r)); body.appendChild(open);
    card.appendChild(body); recipesGrid.appendChild(card);
  }
}
function showRecipe(r){
  recipeDetail.hidden=false;
  const have=r.ingredients.filter(x=>hasIngredient(PANTRY_CACHE,x.name)).map(x=>x.name);
  const miss=r.ingredients.filter(x=>!hasIngredient(PANTRY_CACHE,x.name)).map(x=>x.name);
  recipeDetail.innerHTML=`
    <div class="section-title">${esc(r.title)}</div>
    <div>‚ñ∂Ô∏è <a target="_blank" href="${r.videoUrl}">Video ansehen</a></div>
    <div style="margin-top:8px"><strong>Zutaten</strong></div>
    <ul>${r.ingredients.map(z=>`<li>${esc(z.name)} ${z.amount||''} ${z.unit||''} ${have.includes(z.name)?'‚úÖ':'‚ùå'}</li>`).join('')}</ul>
    <button class="primary" id="addMissing">Fehlende ‚Üí Einkaufsliste</button>
  `;
  document.getElementById('addMissing').onclick=async()=>{
    const all=await getAll();
    for(const name of miss){
      // Suche √§hnliches Produkt
      let it=all.find(x=>normalize(x.name).includes(normalize(name)));
      if(!it){ // neu anlegen als Platzhalter
        it={id:crypto.randomUUID(),name,qty:0,unit:'',cat:'üßë‚Äçüç≥ Kochbuch',place:'Vorratsschrank',mhd:'',imgData:seedImage('üìù','#eef'),archived:false,createdAt:new Date().toISOString()};
      } else { it.qty=0; }
      await put({...it,updatedAt:new Date().toISOString()});
    }
    go('shop'); await rebuildShopList();
  };
}

/* ========== MARKETS (Demo Sektion) ========== */
const MARKETS=[
  {name:'Lidl',icon:'üü°',desc:'Beliebte Basics & Vemondo',cat:'üè™ Lidl'},
  {name:'Aldi',icon:'üî∑',desc:'Nord/S√ºd ‚Äì Klassiker',cat:'üè™ Aldi'},
  {name:'Rewe',icon:'üü•',desc:'Markenauswahl',cat:'üè™ Rewe'},
  {name:'Action',icon:'üü£',desc:'Haushalt & Snacks',cat:'üè™ Action'},
  {name:'T√ºrkischer Markt',icon:'üïå',desc:'Yufka, Feta, Oliven',cat:'üè™ T√ºrkischer Markt'}
];
function buildMarkets(){
  marketGrid.innerHTML='';
  for(const m of MARKETS){
    const card=document.createElement('div'); card.className='tile';
    const imgwrap=document.createElement('div'); imgwrap.className='imgwrap'; imgwrap.textContent=m.icon;
    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`<div class="name">${esc(m.name)}</div><div class="meta">${esc(m.desc)}</div>`;
    const open=btn('Ansehen',()=>{ go('inventory-view'); ACTIVE_CAT=m.cat; render(); });
    body.appendChild(open); card.append(imgwrap,body); marketGrid.appendChild(card);
  }
}

/* ========== AI TWINS (simple seasonal outfits + messages) ========== */
function drawAvatar(el,name){
  // simple SVG avatar with seasonal accessory
  const m=new Date().getMonth()+1;
  let acc=''; // accessory emoji
  if([12,1,2].includes(m)) acc='üß£'; // winter scarf
  else if([6,7,8].includes(m)) acc='üï∂Ô∏è';
  else if([4,5].includes(m)) acc='üåº';
  else if([9,10].includes(m)) acc='üçÅ';
  const bg=m===12? '#e7f5ff' : '#fff';
  el.innerHTML=`<svg viewBox="0 0 100 100" width="54" height="54">
    <rect x="0" y="0" width="100" height="100" rx="50" fill="${bg}"/>
    <circle cx="50" cy="38" r="18" fill="#ffd6a5"/>
    <rect x="28" y="58" width="44" height="26" rx="13" fill="${name==='Ilyan'?'#74c0fc':'#69db7c'}"/>
    <text x="50" y="42" text-anchor="middle" font-size="10">üòä</text>
    <text x="50" y="74" text-anchor="middle" font-size="10" dominant-baseline="middle" fill="#fff">${name}</text>
    <text x="84" y="18" font-size="14">${acc}</text>
  </svg>`;
}
const LINES_I=[
  'Ich checke dein MHD üëÄ',
  '2 Produkte laufen bald ab',
  'Denk an den K√ºhlschrank!'
];
const LINES_L=[
  'Ich mach die Einkaufsliste üõí',
  'Du brauchst Spaghetti?',
  'Sollen wir √ñl nachkaufen?'
];
function rotateLines(){
  msgI.textContent = LINES_I[Math.floor(Math.random()*LINES_I.length)];
  msgL.textContent = LINES_L[Math.floor(Math.random()*LINES_L.length)];
}
setInterval(rotateLines, 8000);

/* ========== Notifications (with image if possible) ========== */
async function requestNotif(){ try{
  if(!('Notification' in window)) return alert('Benachrichtigungen nicht unterst√ºtzt');
  const p=await Notification.requestPermission(); if(p!=='granted') return;
  showMhdNotifications();
} catch(e){ console.log(e); } }
async function showMhdNotifications(){
  const all=await getAll();
  const soon=all.filter(it=>{const d=daysUntil(it.mhd); return d!==null && d>=0 && d<=Number(soonDays.value||14) && !it.archived;}).slice(0,3);
  for(const it of soon){
    if('Notification' in window && Notification.permission==='granted'){
      new Notification('Bald ablaufend: '+it.name,{body:(it.mhd?'MHD: '+it.mhd:''), image: it.imgData||it.imgUrl||undefined, icon: it.imgData||undefined});
    } else {
      showNotice(it,'Bald ablaufend');
    }
  }
}
function showNotice(it,txt){
  noticeImg.src=it.imgData||it.imgUrl||''; noticeText.textContent=txt+': '+it.name;
  notice.hidden=false; setTimeout(()=>notice.hidden=true, 2500);
}

/* ========== Dialog: add/edit product ========== */
const dlg=document.getElementById('dlg'), form=document.getElementById('form'), preview=document.getElementById('preview'), imgfile=document.getElementById('imgfile');
function openDialog(it){
  form.reset(); preview.src=''; delete preview.dataset.dataurl;
  document.getElementById('dlgTitle').textContent = it ? 'Produkt bearbeiten' : 'Produkt hinzuf√ºgen';
  if(it){ for(const [k,v] of Object.entries(it)){ if(form.elements[k]) form.elements[k].value=v??''; } if(it.imgData){preview.src=it.imgData; preview.dataset.dataurl=it.imgData;} else if(it.imgUrl){preview.src=it.imgUrl;} }
  dlg.showModal();
}
document.getElementById('cancel').addEventListener('click',()=>dlg.close());
document.getElementById('del').addEventListener('click', async ()=>{
  const id=new FormData(form).get('id'); if(id && confirm('L√∂schen?')){ await delItem(id); dlg.close(); render(); }
});
document.getElementById('save').addEventListener('click', async ()=>{
  const fd=new FormData(form);
  const item={ id:fd.get('id')||crypto.randomUUID(), name:(fd.get('name')||'').trim(), qty:Number(fd.get('qty')||0),
    unit:(fd.get('unit')||'').trim(), cat:(fd.get('cat')||'').trim(), mhd:fd.get('mhd')||'', place:(fd.get('place')||'').trim(),
    notes:(fd.get('notes')||'').trim(), imgUrl:(fd.get('imgurl')||'').trim(), imgData:preview.dataset.dataurl||'', archived:false,
    updatedAt:new Date().toISOString(), createdAt: fd.get('id') ? undefined : new Date().toISOString()
  };
  if(!item.name) return alert('Name fehlt');
  await put(item); dlg.close(); render();
});
imgfile.addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const b64=await fileToDataURL(f);
  form.elements['imgurl'].value=''; preview.src=b64; preview.dataset.dataurl=b64;
});
form.elements['imgurl'].addEventListener('input', ()=>{ preview.src=form.elements['imgurl'].value||''; delete preview.dataset.dataurl;});

/* ========== NAVIGATION ========= */
function go(where){
  // hide all pages
  home.hidden=app.hidden=shopPage.hidden=cookPage.hidden=dashPage.hidden=marketPage.hidden=true;
  ai.hidden=false; // twins sichtbar in app pages
  if(where==='home'){ home.hidden=false; ai.hidden=true; }
  if(where==='inventory-view' || where==='inventory-edit'){ app.hidden=false; EDIT_MODE=(where==='inventory-edit'); addBtn.style.display=EDIT_MODE?'':'none'; render(); }
  if(where==='shop'){ shopPage.hidden=false; rebuildShopList(); }
  if(where==='cookbook'){ cookPage.hidden=false; buildRecipes(); }
  if(where==='dashboard'){ dashPage.hidden=false; getAll().then(buildDashboard); }
  if(where==='markets'){ marketPage.hidden=false; buildMarkets(); }
}
document.querySelectorAll('.choice').forEach(b=>b.dataset.go && b.addEventListener('click',()=>go(b.dataset.go)));
document.getElementById('installBtn').addEventListener('click',()=>alert('In Safari: Teilen ‚Üí Zum Home-Bildschirm'));
document.getElementById('notifBtn').addEventListener('click',requestNotif);
document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; try{ const arr=JSON.parse(await f.text()); const tx=db.transaction(STORE,'readwrite'); const s=tx.objectStore(STORE); for(const it of arr) s.put(it); tx.oncomplete=render; } catch{ alert('Import fehlgeschlagen'); }
});
document.getElementById('export').addEventListener('click', async ()=>{
  const data=await getAll(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'pantry-export.json'}); a.click(); URL.revokeObjectURL(url);
});
backHome.addEventListener('click',()=>go('home'));
qEl.addEventListener('input', render); locFilter.addEventListener('change', render);
langSel.value=LANG; langHome.value=LANG;
[langSel,langHome].forEach(sel=>sel.addEventListener('change',()=>{ LANG=sel.value; localStorage.setItem('pantry-lang',LANG); render(); }));
soonDays.addEventListener('input',()=>{ localStorage.setItem('pantry-soon', soonDays.value||'14'); render(); });
document.getElementById('add').addEventListener('click',()=>openDialog());

/* ========== TTS (Vorlesen) ========= */
ttsBtn.addEventListener('click',()=>{ const u=new SpeechSynthesisUtterance(`${msgI.textContent}. ${msgL.textContent}`); u.lang=LANG==='tr'?'tr-TR':(LANG==='en'?'en-US':'de-DE'); speechSynthesis.speak(u); });

/* ========== INIT ========= */
(async function(){
  await openDB(); await seedIfEmpty();
  soonDays.value = localStorage.getItem('pantry-soon') || '14';
  drawAvatar(avI,'Ilyan'); drawAvatar(avL,'Liaz'); rotateLines();
  go('home'); // start at home
  // beim Start gleich warnen (falls erlaubt)
  setTimeout(showMhdNotifications,1000);
})();
</script>
</body>
</html>
